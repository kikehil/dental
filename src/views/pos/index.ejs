<%- include('../layout', { body: `
<div class="grid lg:grid-cols-3 gap-6">
  <!-- Catálogo -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-sm p-4">
      <div class="flex gap-4 border-b">
        <button onclick="mostrarTab('servicios')" id="tabServicios" class="px-4 py-2 border-b-2 border-primary-500 text-primary-600 font-medium">
          <i class="fas fa-teeth mr-2"></i> Servicios
        </button>
        <button onclick="mostrarTab('productos')" id="tabProductos" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
          <i class="fas fa-box mr-2"></i> Productos
        </button>
      </div>
    </div>

    <!-- Servicios -->
    <div id="listaServicios" class="grid md:grid-cols-2 gap-4">
      ` + servicios.map(function(s) {
        return '<div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition cursor-pointer" data-tipo="servicio" data-id="' + s.id + '" data-nombre="' + s.nombre + '" data-precio="' + s.precio + '">' +
          '<div class="flex justify-between items-start">' +
            '<div>' +
              '<h4 class="font-medium text-gray-800">' + s.nombre + '</h4>' +
              '<p class="text-sm text-gray-500">' + (s.categoria || 'General') + ' - ' + s.duracion + ' min</p>' +
            '</div>' +
            '<p class="text-lg font-bold text-primary-600">' + formatCurrency(s.precio) + '</p>' +
          '</div>' +
        '</div>';
      }).join('') + `
    </div>

    <!-- Productos -->
    <div id="listaProductos" class="grid md:grid-cols-2 gap-4 hidden">
      ` + productos.map(function(p) {
        return '<div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition cursor-pointer ' + (p.stock <= 0 ? 'opacity-50' : '') + '" data-tipo="producto" data-id="' + p.id + '" data-nombre="' + p.nombre + '" data-precio="' + p.precio + '" data-stock="' + p.stock + '">' +
          '<div class="flex justify-between items-start">' +
            '<div>' +
              '<h4 class="font-medium text-gray-800">' + p.nombre + '</h4>' +
              '<p class="text-sm text-gray-500">Stock: ' + p.stock + '</p>' +
            '</div>' +
            '<p class="text-lg font-bold text-secondary-600">' + formatCurrency(p.precio) + '</p>' +
          '</div>' +
        '</div>';
      }).join('') + `
    </div>
  </div>

  <!-- Carrito -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-xl shadow-sm p-6 sticky top-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">
        <i class="fas fa-shopping-cart text-primary-500 mr-2"></i> Carrito
      </h3>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Paciente (opcional)</label>
        <select id="pacienteVenta" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <option value="">Cliente general</option>
          ` + pacientes.map(function(p) { return '<option value="' + p.id + '">' + p.nombre + ' ' + p.apellido + '</option>'; }).join('') + `
        </select>
      </div>

      <div id="itemsCarrito" class="my-4 space-y-2 max-h-64 overflow-y-auto">
        <p class="text-gray-500 text-center py-4">Carrito vacío</p>
      </div>

      <div class="border-t pt-4 space-y-2">
        <div class="flex justify-between text-gray-600">
          <span>Subtotal:</span>
          <span id="subtotal">$0.00</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Descuento:</span>
          <input type="number" id="descuento" value="0" min="0" step="0.01" class="w-24 px-2 py-1 border rounded text-right" onchange="actualizarTotales()">
        </div>
        <div class="flex justify-between text-xl font-bold text-gray-800">
          <span>Total:</span>
          <span id="total">$0.00</span>
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Método de pago</label>
        <select id="metodoPago" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <button onclick="procesarVenta()" class="w-full bg-secondary-500 text-white py-3 rounded-lg mt-4 hover:bg-secondary-600 transition font-medium">
        <i class="fas fa-cash-register mr-2"></i> Cobrar
      </button>
    </div>
  </div>
</div>

<script>
let carrito = [];

// Event delegation para agregar items
document.getElementById('listaServicios').addEventListener('click', function(e) {
  const item = e.target.closest('[data-tipo]');
  if (item) {
    agregarItem(item.dataset.tipo, parseInt(item.dataset.id), item.dataset.nombre, parseFloat(item.dataset.precio));
  }
});

document.getElementById('listaProductos').addEventListener('click', function(e) {
  const item = e.target.closest('[data-tipo]');
  if (item && parseInt(item.dataset.stock) > 0) {
    agregarItem(item.dataset.tipo, parseInt(item.dataset.id), item.dataset.nombre, parseFloat(item.dataset.precio));
  }
});

function mostrarTab(tab) {
  document.getElementById('listaServicios').classList.toggle('hidden', tab !== 'servicios');
  document.getElementById('listaProductos').classList.toggle('hidden', tab !== 'productos');
  document.getElementById('tabServicios').classList.toggle('border-primary-500', tab === 'servicios');
  document.getElementById('tabServicios').classList.toggle('text-primary-600', tab === 'servicios');
  document.getElementById('tabProductos').classList.toggle('border-primary-500', tab === 'productos');
  document.getElementById('tabProductos').classList.toggle('text-primary-600', tab === 'productos');
}

function agregarItem(tipo, id, nombre, precio) {
  const existe = carrito.find(i => i.tipo === tipo && i.id === id);
  if (existe) {
    existe.cantidad++;
  } else {
    carrito.push({ tipo, id, nombre, precio, cantidad: 1 });
  }
  renderCarrito();
}

function quitarItem(index) {
  carrito.splice(index, 1);
  renderCarrito();
}

function cambiarCantidad(index, delta) {
  carrito[index].cantidad += delta;
  if (carrito[index].cantidad <= 0) {
    carrito.splice(index, 1);
  }
  renderCarrito();
}

function renderCarrito() {
  const container = document.getElementById('itemsCarrito');
  if (carrito.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">Carrito vacío</p>';
  } else {
    container.innerHTML = carrito.map(function(item, i) {
      return '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">' +
        '<div class="flex-1">' +
          '<p class="text-sm font-medium text-gray-800">' + item.nombre + '</p>' +
          '<p class="text-xs text-gray-500">$' + item.precio.toFixed(2) + ' x ' + item.cantidad + '</p>' +
        '</div>' +
        '<div class="flex items-center gap-2">' +
          '<button onclick="cambiarCantidad(' + i + ', -1)" class="w-6 h-6 bg-gray-200 rounded text-gray-600 hover:bg-gray-300">-</button>' +
          '<span class="w-6 text-center">' + item.cantidad + '</span>' +
          '<button onclick="cambiarCantidad(' + i + ', 1)" class="w-6 h-6 bg-gray-200 rounded text-gray-600 hover:bg-gray-300">+</button>' +
          '<button onclick="quitarItem(' + i + ')" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash"></i></button>' +
        '</div>' +
      '</div>';
    }).join('');
  }
  actualizarTotales();
}

function actualizarTotales() {
  const subtotal = carrito.reduce(function(sum, item) { return sum + (item.precio * item.cantidad); }, 0);
  const descuento = parseFloat(document.getElementById('descuento').value) || 0;
  const total = subtotal - descuento;
  document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
  document.getElementById('total').textContent = '$' + total.toFixed(2);
}

function procesarVenta() {
  if (carrito.length === 0) {
    alert('El carrito está vacío');
    return;
  }

  var data = {
    pacienteId: document.getElementById('pacienteVenta').value || null,
    items: carrito,
    descuento: parseFloat(document.getElementById('descuento').value) || 0,
    metodoPago: document.getElementById('metodoPago').value
  };

  fetch('/pos/venta', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(function(response) { return response.json(); })
  .then(function(result) {
    if (result.success) {
      alert('Venta completada! Folio: ' + result.venta.folio + ' Total: ' + result.venta.total);
      carrito = [];
      renderCarrito();
      document.getElementById('descuento').value = 0;
    } else {
      alert('Error: ' + result.error);
    }
  })
  .catch(function(error) { alert('Error al procesar la venta'); });
}
</script>
`}) %>
