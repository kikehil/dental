<%- include('../layout', { body: `
<div class="flex gap-4 mb-6">
  <select id="filtroDoctor" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
    <option value="all">Todos los doctores</option>
    ${doctores.map(d => '<option value="' + d.id + '">' + d.nombre + ' ' + d.apellido + '</option>').join('')}
  </select>
  <a href="/citas/crear" class="bg-secondary-500 text-white px-4 py-2 rounded-lg hover:bg-secondary-600 transition">
    <i class="fas fa-plus mr-2"></i> Nueva Cita
  </a>
</div>

<div class="bg-white rounded-xl shadow-sm p-6">
  <div id="calendario"></div>
</div>

<!-- Modal Detalle Cita -->
<div id="modalCita" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800">Detalle de Cita</h3>
      <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="modalContenido"></div>
    <div class="flex gap-2 mt-6">
      <button onclick="cambiarEstado('completada')" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
        <i class="fas fa-check mr-1"></i> Completar
      </button>
      <button onclick="cambiarEstado('cancelada')" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
        <i class="fas fa-times mr-1"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<script>
let calendar;
let citaSeleccionada = null;

document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendario');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    locale: 'es',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    slotMinTime: '08:00:00',
    slotMaxTime: '20:00:00',
    allDaySlot: false,
    nowIndicator: true,
    eventClick: function(info) {
      mostrarDetalle(info.event);
    },
    events: function(info, successCallback, failureCallback) {
      const doctorId = document.getElementById('filtroDoctor').value;
      fetch('/citas/api/eventos?start=' + info.startStr + '&end=' + info.endStr + '&doctorId=' + doctorId)
        .then(response => response.json())
        .then(data => successCallback(data))
        .catch(error => failureCallback(error));
    }
  });
  calendar.render();

  document.getElementById('filtroDoctor').addEventListener('change', function() {
    calendar.refetchEvents();
  });
});

function mostrarDetalle(event) {
  citaSeleccionada = event;
  const props = event.extendedProps;
  document.getElementById('modalContenido').innerHTML = 
    '<div class="space-y-3">' +
      '<div><strong>Paciente:</strong> ' + props.paciente + '</div>' +
      '<div><strong>Doctor:</strong> ' + props.doctor + '</div>' +
      '<div><strong>Consultorio:</strong> ' + props.consultorio + '</div>' +
      '<div><strong>Hora:</strong> ' + event.start.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'}) + '</div>' +
      '<div><strong>Motivo:</strong> ' + (props.motivo || 'No especificado') + '</div>' +
      '<div><strong>Estado:</strong> <span class="px-2 py-1 rounded-full text-xs ' + 
        (props.estado === 'completada' ? 'bg-green-100 text-green-700' : props.estado === 'cancelada' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700') + '">' + props.estado + '</span></div>' +
      (props.telefono ? '<div><strong>Teléfono:</strong> <a href="tel:' + props.telefono + '" class="text-primary-600">' + props.telefono + '</a></div>' : '') +
    '</div>';
  document.getElementById('modalCita').classList.remove('hidden');
}

function cerrarModal() {
  document.getElementById('modalCita').classList.add('hidden');
  citaSeleccionada = null;
}

function cambiarEstado(estado) {
  if (!citaSeleccionada) return;
  if (!confirm('¿Cambiar estado a ' + estado + '?')) return;
  
  fetch('/citas/api/' + citaSeleccionada.id + '/estado', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ estado })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      calendar.refetchEvents();
      cerrarModal();
    }
  });
}
</script>
`}) %>

